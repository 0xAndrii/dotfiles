#!/bin/bash
set -e

# Language servers

NODE_VERSION="22"
PYRIGHT_VERSION="1.1.402"
PRETTIER_VERSION="3.5.3"

# Colors
GREEN='\033[0;32m'
NC='\033[0m'

echo "[4/5] Installing language servers..."

# Node.js
if ! command -v node &> /dev/null; then
    echo "  → Installing Node.js v${NODE_VERSION}..."
    curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | sudo -E bash -
    sudo apt-get install -y nodejs
    echo -e "  ${GREEN}✓${NC} Node.js installed"
else
    echo -e "  ${GREEN}✓${NC} Node.js already installed"
fi

# Language servers
echo "  → Installing language servers..."
sudo npm install -g -s \
    prettier@${PRETTIER_VERSION} \
    pyright@${PYRIGHT_VERSION} \
    yaml-language-server@latest
echo -e "  ${GREEN}✓${NC} Language servers installed"

# rust-analyzer (if Rust installed)
if command -v cargo &> /dev/null; then
    if ! command -v rust-analyzer &> /dev/null; then
        echo "  → Installing rust-analyzer..."
        cd /tmp
        ARCH=$(uname -m)
        if [[ "$ARCH" == "x86_64" ]]; then
            curl -sL -o rust-analyzer.gz "https://github.com/rust-lang/rust-analyzer/releases/latest/download/rust-analyzer-x86_64-unknown-linux-gnu.gz"
        else
            curl -sL -o rust-analyzer.gz "https://github.com/rust-lang/rust-analyzer/releases/latest/download/rust-analyzer-aarch64-unknown-linux-gnu.gz"
        fi
        gunzip rust-analyzer.gz
        sudo mv rust-analyzer /usr/local/bin/
        sudo chmod +x /usr/local/bin/rust-analyzer
        echo -e "  ${GREEN}✓${NC} rust-analyzer installed"
    else
        echo -e "  ${GREEN}✓${NC} rust-analyzer already installed"
    fi
fi

echo -e "${GREEN}Done! All tools installed successfully.${NC}"

